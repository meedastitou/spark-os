#!/bin/bash
CHECK_DIR=$1
TARGET_READELF=$2
TARGET_ARCH=$3

# Remove unwanted files
find ${CHECK_DIR} \
    \( -name ".deps" -o -name "obj.target" -o -name "test" -o -name "tests" -o -name "example" -o -name "examples" \) \
    -exec rm -rf '{}' \; 2> /dev/null || true

# Remove executables which are not the correct target arch
for f in $(find ${CHECK_DIR} -executable -type f) ; do
    a=$(${TARGET_READELF} -h $f 2>&1 | sed -r -e '/^  Machine: +(.+)/!d; s//\1/;')
    if [ ! -z "$a" -a "$a" != "${TARGET_ARCH}" ] ; then
        echo "Remove: $f Arch: $a"
        rm -f $f
    fi
done
