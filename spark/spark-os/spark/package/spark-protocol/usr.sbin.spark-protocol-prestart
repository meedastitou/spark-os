#!/bin/sh -e

REDIS_CLI=/usr/bin/redis-cli

#wait until we can connect to redis
printf "Connecting to redis "
until ${REDIS_CLI} info >/dev/null 2>&1 ; do
    printf '.'
    sleep 1
done
printf '\n'

echo "Deleting obsolete protocols"
${REDIS_CLI} KEYS nconf:protocols:spark-protocol-autodesk-fusion-connect:* | xargs ${REDIS_CLI}  DEL >/dev/null 2>&1
${REDIS_CLI} SREM nconf:protocols:keys "spark-protocol-autodesk-fusion-connect" >/dev/null 2>&1

${REDIS_CLI} KEYS nconf:protocols:spark-protocol-flume-http:* | xargs ${REDIS_CLI}  DEL >/dev/null 2>&1
${REDIS_CLI} SREM nconf:protocols:keys "spark-protocol-flume-http" >/dev/null 2>&1

${REDIS_CLI} KEYS nconf:protocols:spark-protocol-google-cloud-datastore:* | xargs ${REDIS_CLI}  DEL >/dev/null 2>&1
${REDIS_CLI} SREM nconf:protocols:keys "spark-protocol-google-cloud-datastore" >/dev/null 2>&1

echo "Done"
